name: "Setup"
runs:
    using: "composite"
    steps:
        - run: |
              # Create with liberal rights, otherwise cache action will complain
              # about permission errors.
              sudo mkdir -p /nix/store
              sudo chmod -R 777 /nix

        - name: Cache nix env take N+1
          uses: actions/cache@v2
          with:
              path: |
                  # See https://github.com/actions/cache/pull/726
                  /nix/store/**
                  # Missing something?
                  /nix/var/nix/*/*
                  /nix/var/nix/db/*
                  /nix/var/nix/db/*/**
                  !/nix/var/nix/daemon-socket/socket
                  !/nix/var/nix/userpool/*
                  !/nix/var/nix/gc.lock
                  !/nix/var/nix/db/big-lock
                  !/nix/var/nix/db/reserved
              key: ${{ runner.os }}-nix-store
        - uses: cachix/install-nix-action@v15
          with:
              nix_path: nixpkgs=channel:nixos-unstable
          shell: bash
        - name: Nix requirements
          run: nix-shell
          shell: bash
        - name: Build
          run: nix-shell --command "npm install && python scripts/generate_types.py && npm exec -w reactivated tsc && playwright install && npm install"
          shell: bash
